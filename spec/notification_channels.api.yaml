# OpenApi header is included in this file to support code highlighting in VSCode
openapi: 3.0.3
info:
  title: Notification Channels API
  version: "1.0.0"
paths:
  /notifications/channels/slack/oauth-redirect:
    get:
      parameters:
        - $ref: "#/components/parameters/state"
      tags:
        - notification_channels
      summary: "Starts Slack OAuth2 flow"
      description: "Redirects to Slack to start an OAuth2 flow."
      operationId: slackOauthRedirect
      responses:
        "302":
          description: "Redirects to Slack to start an OAuth2 flow that will return to the slack channel configuration afterwards. In case of an error redirects back to the Slack channel configuration with an `error` and a `channelId` parameter."
  /notifications/channels/slack/oauth-callback:
    get:
      parameters:
        - $ref: "#/components/parameters/code"
        - $ref: "#/components/parameters/state"
      tags:
        - notification_channels
      summary: "The OAuth callback for Slack"
      description: "The OAuth callback for Slack, which is used to obtain the access token for the Slack channel."
      operationId: slackOAuthCallback
      responses:
        "302":
          description: "Redirects back to the Slack channel configuration, in case of an error it includes an `error` query parameter. If known also a `channelId` parameter will be included."
  /notifications/channels/slack/{channelId}/listSlackChannels:
    get:
      parameters:
        - $ref: "#/components/parameters/channelId"
      tags:
        - notification_channels
      summary: "List all public Slack channels"
      description: "List all public Slack channels, used for selecting a channel for the notifications"
      operationId: listSlackChannels
      responses:
        "200":
          $ref: "#/components/responses/slackChannels"
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"

  /notifications/channels/slack/{channelId}/joinSlackChannel:
    post:
      parameters:
        - $ref: "#/components/parameters/channelId"
      requestBody:
        $ref: "#/components/requestBodies/joinSlackChannel"
      tags:
        - notification_channels
      summary: "Join the specified Slack channel to send notifications"
      description: "Join the specified Slack channel and configure this notifiation channel to post notifications to the specified slack channel."
      operationId: joinSlackChannel
      responses:
        "200": 
          description: "Successfully joined Slack channel."
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
  /notifications/channels/slack/{channelId}/sendTestMessage:
    post:
      parameters:
        - $ref: "#/components/parameters/channelId"
      tags:
        - notification_channels
      summary: "Join the specified Slack channel to send notifications"
      description: "Join the specified Slack channel and configure this notifiation channel to post notifications to the specified slack channel."
      operationId: sendTestMessage
      responses:
        "200": 
          description: "Successfully sent test message to Slack channel."
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
components:
  parameters:
    channelId:
      in: path
      name: channelId
      required: true
      schema: { $ref: "#/components/schemas/channelId" }
      description: "Channel identifier"
    code:
      in: query
      name: code
      required: true
      schema:
        type: string
      description: "OAuth code from Slack"
    state:
      in: query
      name: state
      required: true
      schema:
        type: string
      description: "State parameter that was passed to Slack, should have the same value as the one passed to Slack."
  requestBodies:
    joinSlackChannel:
      description: "Provide a Slack channel id to join the specified Slack channel"
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackChannelId"
  responses:
    slackChannels:
      description: "List of all available Slack channels to which StackState can send messages."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackChannels"
    slackNotificationChannelError:
      description: "Request cannot be executed becasue SlackNotificationChannel configuration is incomplete."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackNotificationChannelError"
  schemas:
    notificationConfigurationId:
      type: integer
      format: int64
    channelId:
      type: integer
      format: int64
    SlackChannels:
      type: array
      items: 
        $ref: "#/components/schemas/SlackChannel"
    SlackChannel:
      type: object
      properties:
        name: 
          type: string
        id:
          type: string
      required:
       - name
       - id
    SlackChannelId:
      type: object
      properties:
        id:
          type: string
      required:
       - id
    SlackNotificationChannelError:
      type: object
      properties:
        statusCode:
          type: integer
        message:
          type: string
        channelId: 
          type: integer
          format: int64
      required:
        - statusCode
        - message
        - channelId
