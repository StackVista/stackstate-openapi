# OpenApi header is included in this file to support code highlighting in VSCode
openapi: 3.0.3
info:
  title: Notification Channels API
  version: "1.0.0"
paths:
  /notifications/channels/slack/{channelId}:
    get:
      parameters:
        - $ref: "#/components/parameters/channelId"
      tags:
        - notification_channels
      summary: "Get the Slack Notification channel by id"
      description: "Get the slack notification channel by id"
      operationId: getNotificationChannel
      responses:
        "200":
          $ref: "#/components/responses/slackNotificationChannel"
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "404":
          $ref: "#/components/responses/slackNotificationChannelNotFound"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
    delete:
      parameters:
        - $ref: "#/components/parameters/channelId"
      tags:
        - notification_channels
      summary: "Delete the Slack Notification channel by id"
      description: "Delete the slack notification channel by id"
      operationId: deleteNotificationChannel
      responses:
        "200":
          description: "Slack notification channel is deleted."
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "404":
          $ref: "#/components/responses/slackNotificationChannelNotFound"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"

  /notifications/{notificationId}/channels:
    get:
      parameters:
        - $ref: "#/components/parameters/notificationId"
      tags:
        - notification_channels
      summary: "Get all notification channels for the notification"
      description: "Get all notification channels of any type for the specified notification"
      operationId: getNotificationChannels
      responses:
        "200":
          $ref: "#/components/responses/notificationChannels"
        "404":
          $ref: "#/components/responses/notificationNotFound"
        "500":
          $ref: "#/components/responses/notificationChannelError"

  /notifications/channels/slack/oauth-redirect:
    get:
      parameters:
        - $ref: "#/components/parameters/redirectPath"
      tags:
        - notification_channels
      summary: "Starts Slack OAuth2 flow"
      description: "Redirects to Slack to start an OAuth2 flow."
      operationId: slackOauthRedirect
      responses:
        "302":
          description: "Redirects to Slack to start an OAuth2 flow that will return to the slack channel configuration afterwards. In case of an error redirects back to the Slack channel configuration with an `error` and a `channelId` parameter."
  /notifications/channels/slack/oauth-callback:
    get:
      parameters:
        - $ref: "#/components/parameters/code"
        - $ref: "#/components/parameters/state"
      tags:
        - notification_channels
      summary: "The OAuth callback for Slack"
      description: "The OAuth callback for Slack, which is used to obtain the access token for the Slack channel."
      operationId: slackOAuthCallback
      responses:
        "302":
          description: "Redirects back to the Slack channel configuration, in case of an error it includes an `error` query parameter. If known also a `channelId` parameter will be included."
  /notifications/channels/slack/{channelId}/listSlackChannels:
    get:
      parameters:
        - $ref: "#/components/parameters/channelId"
      tags:
        - notification_channels
      summary: "List all public Slack channels"
      description: "List all public Slack channels, used for selecting a channel for the notifications"
      operationId: listSlackChannels
      responses:
        "200":
          $ref: "#/components/responses/slackChannels"
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "404":
          $ref: "#/components/responses/slackNotificationChannelNotFound"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
  /notifications/channels/slack/{channelId}/joinSlackChannel:
    post:
      parameters:
        - $ref: "#/components/parameters/channelId"
      requestBody:
        $ref: "#/components/requestBodies/joinSlackChannel"
      tags:
        - notification_channels
      summary: "Join the specified Slack channel to send notifications"
      description: "Join the specified Slack channel and configure this notifiation channel to post notifications to the specified slack channel."
      operationId: joinSlackChannel
      responses:
        "200": 
          $ref: "#/components/responses/slackNotificationChannel"
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "404":
          $ref: "#/components/responses/slackNotificationChannelNotFound"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
  /notifications/channels/slack/{channelId}/test:
    post:
      parameters:
        - $ref: "#/components/parameters/channelId"
      tags:
        - notification_channels
      summary: "Test the Slack Notification channel"
      description: "Test the Slack Notification channel by sending a test message to the configured Slack channel."
      operationId: test
      responses:
        "200": 
          description: "Successfully sent test message to Slack channel."
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "404":
          $ref: "#/components/responses/slackNotificationChannelNotFound"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
  /notifications/channels/slack/{channelId}/assignNotification:
    post:
      parameters:
        - $ref: "#/components/parameters/channelId"
      requestBody:
        $ref: "#/components/requestBodies/assignNotification"
      tags:
        - notification_channels
      summary: "Assign this channel to the specified Notification Configuration"
      description: "Assign this channel to the specified Notification Configuration"
      operationId: assignNotification
      responses:
        "200": 
          $ref: "#/components/responses/slackNotificationChannel"
        "400":
          $ref: "#/components/responses/slackNotificationChannelError"
        "404":
          $ref: "#/components/responses/slackNotificationChannelNotFound"
        "500":
          $ref: "#/components/responses/slackNotificationChannelError"
components:
  parameters:
    channelId:
      in: path
      name: channelId
      required: true
      schema: { $ref: "#/components/schemas/channelId" }
      description: "Channel identifier"
    notificationId:
      in: path
      name: notificationId
      required: true
      schema: { $ref: "#/components/schemas/notificationId" }
      description: "Channel identifier"
    code:
      in: query
      name: code
      required: true
      schema:
        type: string
      description: "OAuth code from Slack"
    state:
      in: query
      name: state
      required: true
      schema:
        type: string
      description: "State parameter that was passed to Slack, should have the same value as the one passed to Slack."
    redirectPath:
      in: query
      name: redirectPath
      required: true
      schema:
        type: string
      description: "After completing the oauth flow the user will be redirected back to this path, in the UI, on StackState, to continue further setup of the Slack notification channel."
  requestBodies:
    joinSlackChannel:
      description: "Provide a Slack channel id to join the specified Slack channel"
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackChannelId"
    assignNotification:
      description: "Provide a notification id to assign this channel to"
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/NotificationIdBody"
  responses:
    notificationChannels:
      description: "Array of notification channels"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/NotificationChannels"
    slackNotificationChannel:
      description: "Slack notification channel"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackNotificationChannel"
    slackChannels:
      description: "Array of all available Slack channels to which StackState can send messages."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackChannels"
    notificationChannelError:
      description: "Error while executing the request."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/NotificationChannelError"
    notificationNotFound:
      description: "Notification was not found in the database"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/NotificationNotFound"
    slackNotificationChannelError:
      description: "Error while executing the request."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackNotificationChannelError"
    slackNotificationChannelNotFound:
      description: "Slack notification channel was not found in the database"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SlackNotificationChannelNotFound"
  schemas:
    notificationId:
      type: integer
      format: int64
    channelId:
      type: integer
      format: int64
    SlackChannels:
      type: array
      items: 
        $ref: "#/components/schemas/SlackChannel"
    SlackChannel:
      type: object
      properties:
        name: 
          type: string
        id:
          type: string
      required:
       - name
       - id
    SlackChannelId:
      type: object
      properties:
        id:
          type: string
      required:
       - id
    NotificationIdBody:
      type: object
      properties:
        id:
          type: integer
          format: int64
      required:
       - id
    NotificationChannelError:
      type: object
      properties:
        message:
          type: string
        _type:
          type: string
          enum:
            - NotificationChannelError
      required:
        - message
        - _type
    NotificationNotFound:
      type: object
      properties:
        message:
          type: string
        notificationId: 
          type: string
        _type:
          type: string
          enum:
            - NotificationNotFound
      required:
        - message
        - notificationId
        - _type
    SlackNotificationChannelError:
      type: object
      properties:
        message:
          type: string
        channelId: 
          type: string
        _type:
          type: string
          enum:
            - SlackNotificationChannelError
      required:
        - message
        - channelId
        - _type
    SlackNotificationChannelNotFound:
      type: object
      properties:
        message:
          type: string
        channelId: 
          type: string
        _type:
          type: string
          enum:
            - SlackNotificationChannelNotFound
      required:
        - message
        - channelId
        - _type
    NotificationChannels:
      type: array
      items: 
        $ref: "#/components/schemas/NotificationChannel"
    NotificationChannel:
      oneOf:
        - $ref: "#/components/schemas/SlackNotificationChannel"
      discriminator:
        propertyName: _type
    BaseNotificationChannel:
      type: object
      properties:
        id:
          type: integer
          format: int64
        notificationConfigurationId:
          type: integer
          format: int64
      required:
        - id
    SlackNotificationChannel:
      allOf:
        - $ref: "#/components/schemas/BaseNotificationChannel"
        - type: object
          properties:
            _type:
              type: string
              enum: 
                - SlackNotificationChannel
            slackWorkspace:
              type: string
            slackChannel: 
              type: string
            slackChannelId:
              type: string
          required:
            - _type
            - slackWorkspace
